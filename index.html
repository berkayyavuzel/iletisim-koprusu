<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Communication Bridge</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #0f172a;
			--card: #111826;
			--text: #e5e7eb;
			--muted: #94a3b8;
		}
		html, body {
			height: 100%;
		}
		body {
			margin: 0;
			background: var(--bg);
			color: var(--text);
			font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
		}
		.container {
			max-width: 920px;
			margin: 0 auto;
			padding: 24px;
		}
		h1 {
			text-align: center;
			font-size: 28px;
			margin: 8px 0 16px;
		}
		.grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 16px;
		}
		.btn {
			background: var(--card);
			border: 1px solid #1f2937;
			border-radius: 16px;
			padding: 24px;
			text-align: center;
			cursor: pointer;
			transition: transform .05s ease, background .2s ease, border-color .2s ease;
			user-select: none;
		}
		.btn:active {
			transform: scale(0.98);
		}
		.icon {
			font-size: 56px;
			line-height: 1;
		}
		.label {
			display: block;
			margin-top: 12px;
			font-size: 20px;
			color: var(--muted);
		}
		.status {
			text-align: center;
			margin-top: 12px;
			font-size: 14px;
			color: var(--muted);
			min-height: 20px;
		}
		.footer {
			text-align: center;
			margin-top: 16px;
			font-size: 12px;
			color: var(--muted);
		}
		@media (max-width: 680px) {
			.grid {
				grid-template-columns: repeat(2, 1fr);
			}
			.icon { font-size: 48px; }
			.label { font-size: 18px; }
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Ä°letiÅŸim KÃ¶prÃ¼sÃ¼</h1>
		<div class="controls" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; margin-bottom:12px;">
			<button id="repeatBtn" style="padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; cursor:pointer;">Tekrar</button>
			<label style="display:flex; align-items:center; gap:8px; color:#94a3b8;">Ses:
				<input id="volume" type="range" min="0" max="1" step="0.01" value="1"/>
			</label>
			<label style="display:flex; align-items:center; gap:8px; color:#94a3b8;">Ses TÃ¼rÃ¼:
				<select id="gender" style="background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:8px; padding:6px 8px;">
					<option value="female" selected>KadÄ±n</option>
					<option value="male">Erkek</option>
				</select>
			</label>
			<label style="display:none; align-items:center; gap:8px; color:#94a3b8;">
				<input id="browserTts" type="checkbox"/>
				TarayÄ±cÄ± TTS (Google/Chrome)
			</label>

		</div>

		<div class="custom" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-bottom:16px;">
			<input id="customText" placeholder="Ã–zel cÃ¼mle yazÄ±n (Ã¶rn: Annemi gÃ¶rmek istiyorum)" style="min-width:320px; flex:1; background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 12px;"/>
			<button id="customSpeak" style="padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; cursor:pointer;">KonuÅŸ</button>
		</div>

		<div class="tabs" style="display:flex; justify-content:center; gap:8px; margin-bottom:12px;">
			<button class="tab" data-tab="needs" style="padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#1f2937; color:#e5e7eb; cursor:pointer;">Ä°htiyaÃ§larÄ±m</button>
			<button class="tab" data-tab="comm" style="padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer;">Ä°letiÅŸim</button>
			<button class="tab" data-tab="feel" style="padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer;">DuygularÄ±m</button>
		</div>
		<div class="grid" data-panel="needs">
			<div class="btn" data-need="su" data-text="Su istiyorum." style="border-color:#22d3ee">
				<div class="icon">ğŸ’§</div>
				<span class="label">Su</span>
			</div>
			<div class="btn" data-need="yemek" data-text="AÃ§Ä±m." style="border-color:#f59e0b">
				<div class="icon">ğŸ½ï¸</div>
				<span class="label">Yemek</span>
			</div>
			<div class="btn" data-need="tuvalet" data-text="Tuvalete gitmem gerekiyor." style="border-color:#34d399">
				<div class="icon">ğŸš»</div>
				<span class="label">Tuvalet</span>
			</div>
			<div class="btn" data-need="doktor" data-text="Doktora ihtiyacÄ±m var." style="border-color:#60a5fa">
				<div class="icon">ğŸ©º</div>
				<span class="label">Doktor</span>
			</div>
			<div class="btn" data-need="aÄŸrÄ±" data-text="AÄŸrÄ±m var." style="border-color:#f43f5e">
				<div class="icon">ğŸ¤•</div>
				<span class="label">AÄŸrÄ±</span>
			</div>
			<div class="btn" data-need="uyku" data-text="Uyumak istiyorum." style="border-color:#a78bfa">
				<div class="icon">ğŸ˜´</div>
				<span class="label">Uyku</span>
			</div>
			<div class="btn" data-need="hemÅŸire" data-text="HemÅŸireye ihtiyacÄ±m var." style="border-color:#60a5fa">
				<div class="icon">ğŸ§‘â€âš•ï¸</div>
				<span class="label">HemÅŸire</span>
			</div>
			<div class="btn" data-need="ilaÃ§" data-text="Ä°laÃ§larÄ±mÄ± istiyorum." style="border-color:#f59e0b">
				<div class="icon">ğŸ’Š</div>
				<span class="label">Ä°laÃ§</span>
			</div>
			<div class="btn" data-need="yardÄ±m" data-text="YardÄ±m eder misiniz?" style="border-color:#f43f5e">
				<div class="icon">ğŸ†˜</div>
				<span class="label">YardÄ±m</span>
			</div>
			<div class="btn" data-need="battaniye" data-text="ÃœÅŸÃ¼yorum, battaniye istiyorum." style="border-color:#22d3ee">
				<div class="icon">ğŸ§£</div>
				<span class="label">Battaniye</span>
			</div>
			<div class="btn" data-need="sÄ±cak" data-text="SÄ±cakladÄ±m, serinlemek istiyorum." style="border-color:#f59e0b">
				<div class="icon">ğŸ¥µ</div>
				<span class="label">SÄ±cak</span>
			</div>
			<div class="btn" data-need="soÄŸuk" data-text="ÃœÅŸÃ¼yorum, oda sÄ±caklÄ±ÄŸÄ±nÄ± artÄ±rabilir miyiz?" style="border-color:#34d399">
				<div class="icon">ğŸ¥¶</div>
				<span class="label">SoÄŸuk</span>
			</div>
			<div class="btn" data-need="pozisyon" data-text="Pozisyonumu deÄŸiÅŸtirmenizi istiyorum." style="border-color:#a78bfa">
				<div class="icon">ğŸ”„</div>
				<span class="label">Pozisyon</span>
			</div>
			<div class="btn" data-need="banyo" data-text="Banyoya gitmek istiyorum." style="border-color:#34d399">
				<div class="icon">ğŸ›</div>
				<span class="label">Banyo</span>
			</div>
			<div class="btn" data-need="eller" data-text="Ellerimi yÄ±kamak istiyorum." style="border-color:#22d3ee">
				<div class="icon">ğŸ§¼</div>
				<span class="label">Eller</span>
			</div>
			<div class="btn" data-need="aile" data-text="Ailemi aramak istiyorum." style="border-color:#60a5fa">
				<div class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
				<span class="label">Aile</span>
			</div>
			<div class="btn" data-need="telefon" data-text="Telefonumu istiyorum." style="border-color:#f59e0b">
				<div class="icon">ğŸ“±</div>
				<span class="label">Telefon</span>
			</div>
			<div class="btn" data-need="pencereyi aÃ§" data-text="Pencereyi aÃ§abilir misiniz?" style="border-color:#22d3ee">
				<div class="icon">ğŸªŸ</div>
				<span class="label">Pencere AÃ§</span>
			</div>
			<div class="btn" data-need="pencereyi kapa" data-text="Pencereyi kapatabilir misiniz?" style="border-color:#334155">
				<div class="icon">ğŸªŸ</div>
				<span class="label">Pencere Kapa</span>
			</div>
			<div class="btn" data-need="mÃ¼zik" data-text="MÃ¼zik aÃ§abilir misiniz?" style="border-color:#a78bfa">
				<div class="icon">ğŸµ</div>
				<span class="label">MÃ¼zik</span>
			</div>
			<div class="btn" data-need="tv" data-text="Televizyonu aÃ§abilir misiniz?" style="border-color:#60a5fa">
				<div class="icon">ğŸ“º</div>
				<span class="label">TV</span>
			</div>
			<div class="btn" data-need="evet" data-text="Evet." style="border-color:#34d399">
				<div class="icon">ğŸ‘</div>
				<span class="label">Evet</span>
			</div>
			<div class="btn" data-need="hayÄ±r" data-text="HayÄ±r." style="border-color:#f43f5e">
				<div class="icon">ğŸ‘</div>
				<span class="label">HayÄ±r</span>
			</div>
			<div class="btn" data-need="teÅŸekkÃ¼rler" data-text="TeÅŸekkÃ¼r ederim." style="border-color:#f59e0b">
				<div class="icon">ğŸ™</div>
				<span class="label">TeÅŸekkÃ¼rler</span>
			</div>
		</div>

		<div class="grid" data-panel="comm" style="display:none;">
			<div class="btn" data-text="AnlamadÄ±m." style="border-color:#60a5fa"><div class="icon">â“</div><span class="label">AnlamadÄ±m</span></div>
			<div class="btn" data-text="Tekrar sÃ¶yler misin?" style="border-color:#22d3ee"><div class="icon">ğŸ”</div><span class="label">Tekrar</span></div>
			<div class="btn" data-text="Daha yavaÅŸ konuÅŸ lÃ¼tfen." style="border-color:#f59e0b"><div class="icon">ğŸ¢</div><span class="label">YavaÅŸ</span></div>
			<div class="btn" data-text="YÃ¼ksek sesle konuÅŸur musun?" style="border-color:#f43f5e"><div class="icon">ğŸ”Š</div><span class="label">Daha Sesli</span></div>
			<div class="btn" data-text="Evet." style="border-color:#34d399"><div class="icon">ğŸ‘</div><span class="label">Evet</span></div>
			<div class="btn" data-text="HayÄ±r." style="border-color:#f43f5e"><div class="icon">ğŸ‘</div><span class="label">HayÄ±r</span></div>
			<div class="btn" data-text="Bilmiyorum." style="border-color:#a78bfa"><div class="icon">ğŸ¤·</div><span class="label">Bilmiyorum</span></div>
			<div class="btn" data-text="LÃ¼tfen." style="border-color:#60a5fa"><div class="icon">ğŸ™</div><span class="label">LÃ¼tfen</span></div>
			<div class="btn" data-text="TeÅŸekkÃ¼r ederim." style="border-color:#f59e0b"><div class="icon">ğŸ¤</div><span class="label">TeÅŸekkÃ¼r</span></div>
		</div>

		<div class="grid" data-panel="feel" style="display:none;">
			<div class="btn" data-text="AÃ§Ä±m." style="border-color:#f59e0b"><div class="icon">ğŸ½ï¸</div><span class="label">AÃ§Ä±m</span></div>
			<div class="btn" data-text="SusadÄ±m." style="border-color:#22d3ee"><div class="icon">ğŸ’§</div><span class="label">SusadÄ±m</span></div>
			<div class="btn" data-text="Tuvalete gitmem gerek." style="border-color:#34d399"><div class="icon">ğŸš»</div><span class="label">Tuvalet</span></div>
			<div class="btn" data-text="Yoruldum." style="border-color:#a78bfa"><div class="icon">ğŸ˜´</div><span class="label">Yoruldum</span></div>
			<div class="btn" data-text="AÄŸrÄ±m var." style="border-color:#f43f5e"><div class="icon">ğŸ¤•</div><span class="label">AÄŸrÄ±</span></div>
			<div class="btn" data-text="Kendimi iyi hissetmiyorum." style="border-color:#f43f5e"><div class="icon">ğŸ¤¢</div><span class="label">Ä°yi DeÄŸilim</span></div>
			<div class="btn" data-text="Ä°yiyim." style="border-color:#34d399"><div class="icon">ğŸ˜Š</div><span class="label">Ä°yiyim</span></div>
			<div class="btn" data-text="ÃœzgÃ¼nÃ¼m." style="border-color:#60a5fa"><div class="icon">ğŸ˜”</div><span class="label">ÃœzgÃ¼n</span></div>
			<div class="btn" data-text="Mutluyum." style="border-color:#f59e0b"><div class="icon">ğŸ˜„</div><span class="label">Mutlu</span></div>
			<div class="btn" data-text="KÄ±zgÄ±nÄ±m." style="border-color:#f43f5e"><div class="icon">ğŸ˜ </div><span class="label">KÄ±zgÄ±n</span></div>
			<div class="btn" data-text="Bir ÅŸeye ihtiyacÄ±m yok." style="border-color:#94a3b8"><div class="icon">âœ”ï¸</div><span class="label">Ä°htiyacÄ±m Yok</span></div>
		</div>
		<div class="status" id="status"></div>
		<div class="stats" style="text-align:center; margin-top:12px;">
			<button id="refreshStats" style="padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer;">Ä°statistikleri Yenile</button>
			<div id="statsOut" style="margin-top:8px; color:#94a3b8; font-size:14px;"></div>
		</div>
		<div class="footer">KonuÅŸmak iÃ§in bir ikona dokunun</div>
	</div>

		<audio id="player" aria-live="polite"></audio>
	<script>
		const statusEl = document.getElementById('status');
		const player = document.getElementById('player');
		const repeatBtn = document.getElementById('repeatBtn');
		const volume = document.getElementById('volume');
		const genderSel = document.getElementById('gender');
		const browserTts = document.getElementById('browserTts');

		const customText = document.getElementById('customText');
		const customSpeak = document.getElementById('customSpeak');
		const refreshStats = document.getElementById('refreshStats');
		const statsOut = document.getElementById('statsOut');

		let BACKEND_URL;
		if (window.location.protocol === 'file:') {
			BACKEND_URL = 'http://localhost:5000';
		} else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
			BACKEND_URL = 'http://localhost:5000';
		} else {
			// Same origin but force port 5000 if a port exists, otherwise keep origin
			const origin = window.location.origin;
			const hasPort = /:\\d+$/.test(origin);
			BACKEND_URL = hasPort ? origin.replace(/:\\d+$/, ':5000') : origin;
		}
		console.log('Using backend:', BACKEND_URL);

		function setStatus(text) {
			statusEl.textContent = text || '';
		}

		// TarayÄ±cÄ± TTS (Google/Chrome) yardÄ±mcÄ±larÄ±
		let cachedVoices = [];
		function getVoicesOnce(){
			const vs = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
			if (vs && vs.length) cachedVoices = vs;
			return cachedVoices;
		}
		function waitVoices(timeoutMs = 1500){
			return new Promise(resolve => {
				const start = Date.now();
				(function check(){
					const vs = getVoicesOnce();
					if (vs.length || Date.now() - start > timeoutMs) return resolve(vs);
					setTimeout(check, 50);
				})();
			});
		}
		function chooseTurkishVoiceByGender(gender) {
			const voices = getVoicesOnce().filter(v => (v.lang || '').toLowerCase().startsWith('tr'));
			if (!voices.length) return null;
			const FEMALE_PREF = [/google.*turk/i, /seda/i, /zehra/i, /female/i, /kad[Ä±i]n/i];
			const MALE_PREF = [/google.*turk/i, /tolga/i, /ahmet/i, /murat/i, /male/i, /erkek/i];
			const matchPref = (rxs) => voices.find(v => rxs.some(rx => rx.test(v.name))) || null;
			if (gender === 'female') return matchPref(FEMALE_PREF) || voices[0];
			if (gender === 'male') return matchPref(MALE_PREF) || voices[0];
			return voices[0];
		}

		// VarsayÄ±lan: erkek seÃ§iliyken tarayÄ±cÄ± TTS aÃ§Ä±k, kadÄ±n seÃ§iliyken kapalÄ±
		browserTts.checked = (genderSel.value === 'male');
		genderSel.addEventListener('change', () => {
			browserTts.checked = (genderSel.value === 'male');
		});

		async function speakPayload(payload) {
			setStatus('Seslendiriliyorâ€¦');
			try {
				if (browserTts.checked && 'speechSynthesis' in window) {
					await waitVoices();
					const utter = new SpeechSynthesisUtterance(payload.text || '');
					utter.lang = 'tr-TR';
					utter.rate = 1.0;
					utter.volume = parseFloat(volume.value || '1');
					const v = chooseTurkishVoiceByGender(genderSel.value);
					if (v) utter.voice = v;
					window.speechSynthesis.cancel();
					window.speechSynthesis.speak(utter);
					setStatus('');
					lastPayload = payload;
					return;
				}

				const res = await fetch(BACKEND_URL + '/speak', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				if (!res.ok) {
					const err = await res.json().catch(() => ({}));
					throw new Error(err.error || ('HTTP ' + res.status));
				}
				const blob = await res.blob();
				const url = URL.createObjectURL(blob);
				player.src = url;
				await player.play();
				setStatus('');
				lastPayload = payload;
			} catch (e) {
				console.error(e);
				setStatus('Error: ' + (e.message || e));
			}
		}

		async function speakNeed(need, category) {
			const payload = { need, category, lang: 'tr', provider: 'gtts', gender: genderSel.value };
			await speakPayload(payload);
		}

		async function speakText(text, category) {
			const payload = { text, category, lang: 'tr', provider: 'gtts', gender: genderSel.value };
			await speakPayload(payload);
		}

		let lastPayload = null;
		function panelOf(el){
			const panel = el.closest('[data-panel]');
			if (!panel) return undefined;
			return panel.getAttribute('data-panel');
		}
		document.querySelectorAll('.btn').forEach(btn => {
			btn.addEventListener('click', () => {
				const cat = panelOf(btn);
				const txt = btn.dataset.text;
				const need = btn.dataset.need;
				if (txt) speakText(txt, cat); else speakNeed(need, cat);
			});
			btn.setAttribute('role','button');
			btn.setAttribute('aria-label', btn.querySelector('.label').textContent);
			btn.tabIndex = 0;
			btn.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					const cat = panelOf(btn);
					const txt = btn.dataset.text;
					const need = btn.dataset.need;
					if (txt) speakText(txt, cat); else speakNeed(need, cat);
				}
			});
		});

		repeatBtn.addEventListener('click', () => { if (lastPayload) speakPayload(lastPayload); });
		volume.addEventListener('input', () => { player.volume = parseFloat(volume.value || '1'); });

		customSpeak.addEventListener('click', () => {
			const t = (customText.value || '').trim();
			if (!t) { setStatus('LÃ¼tfen cÃ¼mle yazÄ±n'); return; }
			speakText(t, 'custom');
		});

		// Tabs
		const tabs = document.querySelectorAll('.tab');
		const panels = document.querySelectorAll('[data-panel]');
		tabs.forEach(tab => tab.addEventListener('click', () => {
			const target = tab.getAttribute('data-tab');
			tabs.forEach(t => t.style.background = '#0b1220');
			tab.style.background = '#1f2937';
			panels.forEach(p => p.style.display = (p.getAttribute('data-panel') === target ? '' : 'none'));
		}));
		// Default active
		document.querySelector('.tab[data-tab="needs"]').click();

		// Stats
		async function loadStats(){
			try {
				const res = await fetch(BACKEND_URL + '/stats');
				if(!res.ok) throw new Error('HTTP '+res.status);
				const data = await res.json();
				const items = Object.entries(data.counts || {}).sort((a,b)=>b[1]-a[1]).slice(0,10);
				statsOut.innerHTML = items.map(([k,v])=>`${k}: ${v}`).join(' | ') || 'HenÃ¼z veri yok';
			} catch(e){ statsOut.textContent = 'Ä°statistik okunamadÄ±'; }
		}
		refreshStats.addEventListener('click', loadStats);
		loadStats();
	</script>
</body>
</html>


